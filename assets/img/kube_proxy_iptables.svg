<?xml version="1.0" encoding="UTF-8"?>
<!-- Do not edit this file with editors other than diagrams.net -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="1817px" height="9250px" viewBox="-0.5 -0.5 1817 9250" content="&lt;mxfile host=&quot;Electron&quot; modified=&quot;2022-11-23T08:13:37.681Z&quot; agent=&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/19.0.3 Chrome/102.0.5005.63 Electron/19.0.3 Safari/537.36&quot; etag=&quot;ft3tI7CyFVAAPVLNUAfG&quot; version=&quot;19.0.3&quot; type=&quot;device&quot;&gt;&lt;diagram id=&quot;Y-uGvrcz6t8PJfiE86A7&quot; name=&quot;第 1 页&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;" style="background-color: rgb(255, 255, 255);"><defs/><g><path d="M 396 23 L 396 0 L 1366 0 L 1366 23" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><path d="M 396 23 L 396 720 L 1366 720 L 1366 23" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 396 23 L 1366 23" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="880.5" y="16">cmd/kube-proxy/app/server.go</text></g><rect x="396" y="20" width="970" height="700" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 968px; height: 1px; padding-top: 370px; margin-left: 398px;"><div data-drawio-colors="color: #00994D; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 153, 77); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><font color="#7f00ff">// Run runs the specified ProxyServer.  This should never exit (unless CleanupAndExit is set).</font></div><div><font color="#7f00ff">// TODO: At the moment, Run() cannot return a nil error, otherwise it's caller will never exit. Update callers of Run to handle nil errors.</font></div><div><font color="#000000"><b>func (s *ProxyServer) Run()</b> error {</font></div><div><span style="white-space: pre;">	</span>...<br /></div><div><font color="#7f00ff">	// Create configs (i.e. Watches for Services and Endpoints or EndpointSlices)</font></div><div><font color="#7f00ff"><span style="">	</span>// Note: RegisterHandler() calls need to happen before creation of Sources because sources</font></div><div><font color="#7f00ff"><span style="">	</span>// only notify on changes, and the initial update (on process start) may be lost if no handlers</font></div><div><font color="#7f00ff">	// are registered yet.</font></div><div><span style="color: rgb(0, 0, 0);">	</span><b style="">serviceConfig := config.NewServiceConfig(informerFactory.Core().V1().Services(), s.ConfigSyncPeriod)</b></div><div><span style="color: rgb(0, 0, 0);">	</span><b style="">serviceConfig.RegisterEventHandler(s.Proxier)</b></div><div><span style="color: rgb(0, 0, 0);">	</span><b>go serviceConfig.Run(wait.NeverStop)</b></div><div><font color="#000000"><br /></font></div><div><font color="#000000"><span style="">	</span>if endpointsHandler, ok := s.Proxier.(config.EndpointsHandler); ok &amp;&amp; !s.UseEndpointSlices {</font></div><div><span style="color: rgb(0, 0, 0);">		</span><b style="">endpointsConfig := config.NewEndpointsConfig(informerFactory.Core().V1().Endpoints(), s.ConfigSyncPeriod)</b></div><div><span style="color: rgb(0, 0, 0);">		</span><b>endpointsConfig.RegisterEventHandler(endpointsHandler)</b></div><div><span style="color: rgb(0, 0, 0);">		</span><b>go endpointsConfig.Run(wait.NeverStop)</b></div><div><font color="#000000"><span style="">	</span>} else {</font></div><div><span style="color: rgb(0, 0, 0);">		</span><b style="">endpointSliceConfig := config.NewEndpointSliceConfig(informerFactory.Discovery().V1().EndpointSlices(), s.ConfigSyncPeriod)</b></div><div><span style="color: rgb(0, 0, 0);">		</span><b style="">endpointSliceConfig.RegisterEventHandler(s.Proxier)</b></div><div><span style="color: rgb(0, 0, 0);">		</span><b style="">go endpointSliceConfig.Run(wait.NeverStop)</b></div><div><font color="#000000"><span style="">	</span>}</font></div><div><font color="#000000"><br /></font></div><div><font color="#7f00ff">	// This has to start after the calls to NewServiceConfig and NewEndpointsConfig because those</font></div><div><font color="#7f00ff">	// functions must configure their shared informer event handlers first.</font></div><div><font color="#000000"><span style="">	</span>informerFactory.Start(wait.NeverStop)</font></div><div><font color="#000000"><br /></font></div><div><font color="#000000"><span style="">	</span>if utilfeature.DefaultFeatureGate.Enabled(features.TopologyAwareHints) {</font></div><div><span style="color: rgb(0, 0, 0);">		</span><font color="#7f00ff">// Make an informer that selects for our nodename.</font></div><div><font color="#000000"><span style="">		</span>currentNodeInformerFactory := informers.NewSharedInformerFactoryWithOptions(s.Client, s.ConfigSyncPeriod,</font></div><div><font color="#000000"><span style="">			</span>informers.WithTweakListOptions(func(options *metav1.ListOptions) {</font></div><div><font color="#000000"><span style="">				</span>options.FieldSelector = fields.OneTermEqualSelector("metadata.name", s.NodeRef.Name).String()</font></div><div><font color="#000000"><span style="">			</span>}))</font></div><div><span style="color: rgb(0, 0, 0);">		</span><b style="">nodeConfig := config.NewNodeConfig(currentNodeInformerFactory.Core().V1().Nodes(), s.ConfigSyncPeriod)</b></div><div><span style="color: rgb(0, 0, 0);">		</span><b style="">nodeConfig.RegisterEventHandler(s.Proxier)</b></div><div><span style="color: rgb(0, 0, 0);">		</span><b style="">go nodeConfig.Run(wait.NeverStop)</b></div><div><font color="#000000"><br /></font></div><div><font color="#7f00ff">		// This has to start after the calls to NewNodeConfig because that must</font></div><div><font color="#7f00ff">		// configure the shared informer event handler first.</font></div><div><font color="#000000"><span style="">		</span>currentNodeInformerFactory.Start(wait.NeverStop)</font></div><div><font color="#000000"><span style="">	</span>}</font></div><div><font color="#000000"><br /></font></div><div><span style="color: rgb(0, 0, 0);">	</span><font color="#7f00ff">// Birth Cry after the birth is successful</font></div><div><font color="#000000"><span style="">	</span>s.birthCry()</font></div><div><font color="#000000"><br /></font></div><div><font color="#000000"><span style="">	</span>go s.Proxier.SyncLoop()</font></div><div><font color="#000000"><br /></font></div><div><font color="#000000"><span style="">	</span>return &lt;-errCh</font></div><div><font color="#000000">}</font></div></pre></div></div></div></foreignObject><text x="398" y="374" fill="#00994D" font-family="Helvetica" font-size="12px">// Run runs the specified ProxyServer.  This should never exit (unless CleanupAndExit is set)....</text></switch></g><path d="M 526 783 L 526 760 L 1236 760 L 1236 783" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 526 783 L 526 1030 L 1236 1030 L 1236 783" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 526 783 L 1236 783" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="880.5" y="776">pkg/proxy/config/config.go</text></g><rect x="526" y="780" width="710" height="250" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 708px; height: 1px; padding-top: 905px; margin-left: 528px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><font color="#7f00ff">// NewServiceConfig creates a new ServiceConfig.</font></div><div><b>func NewServiceConfig</b>(serviceInformer coreinformers.ServiceInformer, resyncPeriod time.Duration) *ServiceConfig {</div><div><span style="">	</span>result := &amp;ServiceConfig{</div><div><span style="">		</span>listerSynced: serviceInformer.Informer().HasSynced,</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>serviceInformer.Informer().AddEventHandlerWithResyncPeriod(</div><div><span style="">		</span>cache.ResourceEventHandlerFuncs{</div><div><span style="">			</span>AddFunc:    <b><font color="#00994d">result.handleAddService</font></b>,</div><div><span style="">			</span>UpdateFunc:   <b><font color="#00994d">result.handleUpdateService</font></b>,</div><div><span style="">			</span>DeleteFunc:   <b><font color="#00994d">result.handleDeleteService</font></b>,</div><div><span style="">		</span>},</div><div><span style="">		</span>resyncPeriod,</div><div><span style="">	</span>)</div><div><br /></div><div><span style="">	</span>return result</div><div>}</div></pre></div></div></div></foreignObject><text x="528" y="909" fill="#000000" font-family="Helvetica" font-size="12px">// NewServiceConfig creates a new ServiceConfig....</text></switch></g><path d="M 0 1103 L 0 1080 L 526 1080 L 526 1103" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 0 1103 L 0 1260 L 526 1260 L 526 1103" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 0 1103 L 526 1103" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="262.5" y="1096">pkg/proxy/config/config.go</text></g><rect x="0" y="1100" width="526" height="160" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 524px; height: 1px; padding-top: 1180px; margin-left: 2px;"><div data-drawio-colors="color: #00994D; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 153, 77); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><font color="#000000"><b>func (c *ServiceConfig) handleAddService</b>(obj interface{}) {</font></div><div><font color="#000000"><span style="">	</span>service, ok := obj.(*v1.Service)</font></div><div><font color="#000000"><span style="">	</span>if !ok {</font></div><div><font color="#000000"><span style="">		</span>utilruntime.HandleError(fmt.Errorf("unexpected object type: %v", obj))</font></div><div><font color="#000000"><span style="">		</span>return</font></div><div><font color="#000000"><span style="">	</span>}</font></div><div><font color="#000000"><span style="">	</span>for i := range c.eventHandlers {</font></div><div><font color="#000000"><span style="">		</span>klog.V(4).InfoS("Calling handler.OnServiceAdd")</font></div><div><span style="color: rgb(0, 0, 0);">		</span><b style="">c.eventHandlers[i].OnServiceAdd(service)</b></div><div><font color="#000000"><span style="">	</span>}</font></div><div><font color="#000000">}</font></div></pre></div></div></div></foreignObject><text x="2" y="1184" fill="#00994D" font-family="Helvetica" font-size="12px">func (c *ServiceConfig) handleAddService(obj interface{}) {...</text></switch></g><path d="M 606 1103 L 606 1080 L 1156 1080 L 1156 1103" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 606 1103 L 606 1330 L 1156 1330 L 1156 1103" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 606 1103 L 1156 1103" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="880.5" y="1096">pkg/proxy/config/config.go</text></g><rect x="606" y="1100" width="550" height="230" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 548px; height: 1px; padding-top: 1215px; margin-left: 608px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><b>func (c *ServiceConfig) handleUpdateService</b>(oldObj, newObj interface{}) {</div><div><span style="">	</span>oldService, ok := oldObj.(*v1.Service)</div><div><span style="">	</span>if !ok {</div><div><span style="">		</span>utilruntime.HandleError(fmt.Errorf("unexpected object type: %v", oldObj))</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><span style="">	</span>service, ok := newObj.(*v1.Service)</div><div><span style="">	</span>if !ok {</div><div><span style="">		</span>utilruntime.HandleError(fmt.Errorf("unexpected object type: %v", newObj))</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><span style="">	</span>for i := range c.eventHandlers {</div><div><span style="">		</span>klog.V(4).InfoS("Calling handler.OnServiceUpdate")</div><div><span style="">		</span><b><font color="#00994d">c.eventHandlers[i].OnServiceUpdate(oldService, service)</font></b></div><div><span style="">	</span>}</div><div>}</div></pre></div></div></div></foreignObject><text x="608" y="1219" fill="#000000" font-family="Helvetica" font-size="12px">func (c *ServiceConfig) handleUpdateService(oldObj, newObj interface{}) {...</text></switch></g><path d="M 1236 1103 L 1236 1080 L 1816 1080 L 1816 1103" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1236 1103 L 1236 1360 L 1816 1360 L 1816 1103" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1236 1103 L 1816 1103" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="1525.5" y="1096">pkg/proxy/config/config.go</text></g><rect x="1236" y="1100" width="580" height="260" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 578px; height: 1px; padding-top: 1230px; margin-left: 1238px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><b>func (c *ServiceConfig) handleDeleteService</b>(obj interface{}) {</div><div><span style="">	</span>service, ok := obj.(*v1.Service)</div><div><span style="">	</span>if !ok {</div><div><span style="">		</span>tombstone, ok := obj.(cache.DeletedFinalStateUnknown)</div><div><span style="">		</span>if !ok {</div><div><span style="">			</span>utilruntime.HandleError(fmt.Errorf("unexpected object type: %v", obj))</div><div><span style="">			</span>return</div><div><span style="">		</span>}</div><div><span style="">		</span>if service, ok = tombstone.Obj.(*v1.Service); !ok {</div><div><span style="">			</span>utilruntime.HandleError(fmt.Errorf("unexpected object type: %v", obj))</div><div><span style="">			</span>return</div><div><span style="">		</span>}</div><div><span style="">	</span>}</div><div><span style="">	</span>for i := range c.eventHandlers {</div><div><span style="">		</span>klog.V(4).InfoS("Calling handler.OnServiceDelete")</div><div><span style="">		</span><b><font color="#00994d">c.eventHandlers[i].OnServiceDelete(service)</font></b></div><div><span style="">	</span>}</div><div>}</div></pre></div></div></div></foreignObject><text x="1238" y="1234" fill="#000000" font-family="Helvetica" font-size="12px">func (c *ServiceConfig) handleDeleteService(obj interface{}) {...</text></switch></g><path d="M 53 1456 L 53 1433 L 473 1433 L 473 1456" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 53 1456 L 53 1533 L 473 1533 L 473 1456" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 53 1456 L 473 1456" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="262.5" y="1449">pkg/proxy/iptables/proxier.go</text></g><rect x="53" y="1453" width="420" height="80" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 418px; height: 1px; padding-top: 1493px; margin-left: 55px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><font color="#7f00ff">// OnServiceAdd is called whenever creation of new service object</font></div><div><font color="#7f00ff">// is observed.</font></div><div>func (proxier *Proxier) OnServiceAdd(service *v1.Service) {</div><div><span style="">	</span><b><font color="#00994d">proxier.OnServiceUpdate(nil, service)</font></b></div><div>}</div></pre></div></div></div></foreignObject><text x="55" y="1497" fill="#000000" font-family="Helvetica" font-size="12px">// OnServiceAdd is called whenever creation of new service object...</text></switch></g><path d="M 606 1446 L 606 1423 L 1156 1423 L 1156 1446" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 606 1446 L 606 1543 L 1156 1543 L 1156 1446" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 606 1446 L 1156 1446" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="880.5" y="1439">pkg/proxy/iptables/proxier.go</text></g><rect x="606" y="1443" width="550" height="100" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 548px; height: 1px; padding-top: 1493px; margin-left: 608px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><font color="#7f00ff">// OnServiceUpdate is called whenever modification of an existing</font></div><div><font color="#7f00ff">// service object is observed.</font></div><div><b>func (proxier *Proxier) OnServiceUpdate</b>(oldService, service *v1.Service) {</div><div><span style="">	</span>if proxier.serviceChanges.Update(oldService, service) &amp;&amp; proxier.isInitialized() {</div><div><span style="">		</span><font color="#00994d"><b>proxier.Sync()</b></font></div><div><span style="">	</span>}</div><div>}</div></pre></div></div></div></foreignObject><text x="608" y="1497" fill="#000000" font-family="Helvetica" font-size="12px">// OnServiceUpdate is called whenever modification of an existing...</text></switch></g><path d="M 1311.5 1434 L 1311.5 1411 L 1740.5 1411 L 1740.5 1434" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1311.5 1434 L 1311.5 1533 L 1740.5 1533 L 1740.5 1434" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1311.5 1434 L 1740.5 1434" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="1525.5" y="1427">pkg/proxy/iptables/proxier.go</text></g><rect x="1311.5" y="1433" width="429" height="100" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 427px; height: 1px; padding-top: 1483px; margin-left: 1314px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><font color="#7f00ff">// OnServiceDelete is called whenever deletion of an existing service</font></div><div><font color="#7f00ff">// object is observed.</font></div><div><b>func (proxier *Proxier) OnServiceDelete</b>(service *v1.Service) {</div><div><span style="">	</span><b><font color="#00994d">proxier.OnServiceUpdate(service, nil)</font></b></div><div><br /></div><div>}</div></pre></div></div></div></foreignObject><text x="1314" y="1487" fill="#000000" font-family="Helvetica" font-size="12px">// OnServiceDelete is called whenever deletion of an existing service...</text></switch></g><path d="M 626 1643 L 626 1620 L 1136 1620 L 1136 1643" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 626 1643 L 626 1830 L 1136 1830 L 1136 1643" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 626 1643 L 1136 1643" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="880.5" y="1636">pkg/proxy/config/config.go</text></g><rect x="626" y="1640" width="510" height="190" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 508px; height: 1px; padding-top: 1735px; margin-left: 628px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><font color="#7f00ff">// Run waits for cache synced and invokes handlers after syncing.</font></div><div><b>func (c *ServiceConfig) Run</b>(stopCh &lt;-chan struct{}) {</div><div><span style="">	</span>klog.InfoS("Starting service config controller")</div><div><br /></div><div><span style="">	</span>if !cache.WaitForNamedCacheSync("service config", stopCh, c.listerSynced) {</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>for i := range c.eventHandlers {</div><div><span style="">		</span>klog.V(3).InfoS("Calling handler.OnServiceSynced()")</div><div><span style="">		</span><b><font color="#00994d">c.eventHandlers[i].OnServiceSynced()</font></b></div><div><span style="">	</span>}</div><div>}</div></pre></div></div></div></foreignObject><text x="628" y="1739" fill="#000000" font-family="Helvetica" font-size="12px">// Run waits for cache synced and invokes handlers after syncing....</text></switch></g><path d="M 881 720 L 881 753.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 881 758.88 L 877.5 751.88 L 881 753.63 L 884.5 751.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 881 1030 L 881 1073.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 881 1078.88 L 877.5 1071.88 L 881 1073.63 L 884.5 1071.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 881 1030 L 881 1055 L 263 1055 L 263 1073.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 263 1078.88 L 259.5 1071.88 L 263 1073.63 L 266.5 1071.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 881 1030 L 881 1055 L 1526 1055 L 1526 1073.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1526 1078.88 L 1522.5 1071.88 L 1526 1073.63 L 1529.5 1071.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1526 1360 L 1526 1404.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1526 1409.88 L 1522.5 1402.88 L 1526 1404.63 L 1529.5 1402.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 881 1330 L 881 1416.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 881 1421.88 L 877.5 1414.88 L 881 1416.63 L 884.5 1414.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 881 1543 L 881 1613.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 881 1618.88 L 877.5 1611.88 L 881 1613.63 L 884.5 1611.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1311.5 1483 L 1162.37 1483" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1157.12 1483 L 1164.12 1479.5 L 1162.37 1483 L 1164.12 1486.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 473 1493 L 599.63 1493" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 604.88 1493 L 597.88 1496.5 L 599.63 1493 L 597.88 1489.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 263 1260 L 263 1426.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 263 1431.88 L 259.5 1424.88 L 263 1426.63 L 266.5 1424.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 621 1893 L 621 1870 L 1141 1870 L 1141 1893" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 621 1893 L 621 2060 L 1141 2060 L 1141 1893" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 621 1893 L 1141 1893" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="880.5" y="1886">pkg/proxy/iptables/proxier.go</text></g><rect x="621" y="1890" width="520" height="170" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 518px; height: 1px; padding-top: 1975px; margin-left: 623px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><font color="#7f00ff">// OnServiceSynced is called once all the initial event handlers were</font></div><div><font color="#7f00ff">// called and the state is fully propagated to local cache.</font></div><div><b>func (proxier *Proxier) OnServiceSynced</b>() {</div><div><span style="">	</span>proxier.mu.Lock()</div><div><span style="">	</span>proxier.servicesSynced = true</div><div><span style="">	</span>proxier.setInitialized(proxier.endpointSlicesSynced)</div><div><span style="">	</span>proxier.mu.Unlock()</div><div><br /></div><div><span style="">	</span><font color="#7f00ff">// Sync unconditionally - this is called once per lifetime.</font></div><div><span style="">	</span><b><font color="#00994d">proxier.syncProxyRules()</font></b></div><div>}</div></pre></div></div></div></foreignObject><text x="623" y="1979" fill="#000000" font-family="Helvetica" font-size="12px">// OnServiceSynced is called once all the initial event handlers were...</text></switch></g><path d="M 881 1830 L 881 1863.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 881 1868.88 L 877.5 1861.88 L 881 1863.63 L 884.5 1861.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 381 2123 L 381 2100 L 1381 2100 L 1381 2123" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 381 2123 L 381 9243 L 1381 9243 L 1381 2123" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 381 2123 L 1381 2123" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="880.5" y="2116">pkg/proxy/iptables/proxier.go</text></g><rect x="381" y="2123" width="1000" height="7120" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 998px; height: 1px; padding-top: 5683px; margin-left: 383px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><div><font color="#7f00ff">// This is where all of the iptables-save/restore calls happen.</font></div><div><font color="#7f00ff">// The only other iptables rules are those that are setup in iptablesInit()</font></div><div><font color="#7f00ff">// This assumes proxier.mu is NOT held</font></div><div><b>func (proxier *Proxier) syncProxyRules</b>() {</div><div><span style="white-space: pre;">	</span>...<br /></div><div><span style="">	</span>klog.V(2).InfoS("Syncing iptables rules")</div><div><br /></div><div><span style="">	</span>success := false</div><div><span style="">	</span>defer func() {</div><div><span style="">		</span>if !success {</div><div><span style="">			</span>klog.InfoS("Sync failed", "retryingTime", proxier.syncPeriod)</div><div><span style="">			</span>proxier.syncRunner.RetryAfter(proxier.syncPeriod)</div><div><span style="">		</span>}</div><div><span style="">	</span>}()</div><div><span style="white-space: pre;">	</span>...<br /></div><div><br /></div><div><font color="#7f00ff"><span style="">	</span>//</font></div><div><font color="#7f00ff"><span style="">	</span>// Below this point we will not return until we try to write the iptables rules.</font></div><div><font color="#7f00ff"><span style="">	</span>//</font></div><div><br /></div><div><font color="#7f00ff"><span style="">	</span>// Get iptables-save output so we can check for existing chains and rules.</font></div><div><font color="#7f00ff"><span style="">	</span>// This will be a map of chain name to chain with rules as stored in iptables-save/iptables-restore</font></div><div><span style="">	</span>existingFilterChains := make(map[utiliptables.Chain][]byte)</div><div><span style="">	</span>proxier.existingFilterChainsData.Reset()</div><div><span style="">	</span>err := <b><font color="#00994d">proxier.iptables.SaveInto(utiliptables.TableFilter, proxier.existingFilterChainsData)</font></b></div><div><span style="">	</span>if err != nil { // if we failed to get any rules</div><div><span style="">		</span>klog.ErrorS(err, "Failed to execute iptables-save, syncing all rules")</div><div><span style="">	</span>} else { // otherwise parse the output</div><div><span style="">		</span>existingFilterChains = utiliptables.GetChainLines(utiliptables.TableFilter, proxier.existingFilterChainsData.Bytes())</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span><font color="#7f00ff">// IMPORTANT: existingNATChains may share memory with proxier.iptablesData.</font></div><div><span style="">	</span>existingNATChains := make(map[utiliptables.Chain][]byte)</div><div><span style="">	</span>proxier.iptablesData.Reset()</div><div><span style="">	</span>err = <b><font color="#00994d">proxier.iptables.SaveInto(utiliptables.TableNAT, proxier.iptablesData)</font></b></div><div><span style="">	</span>if err != nil { // if we failed to get any rules</div><div><span style="">		</span>klog.ErrorS(err, "Failed to execute iptables-save, syncing all rules")</div><div><span style="">	</span>} else { // otherwise parse the output</div><div><span style="">		</span>existingNATChains = utiliptables.GetChainLines(utiliptables.TableNAT, proxier.iptablesData.Bytes())</div><div><span style="">	</span>}</div><div><br /></div><div><font color="#7f00ff"><span style="">	</span>// Reset all buffers used later.(implement via LineBuffer located at pkg/proxy/util/utils.go)</font></div><div><font color="#7f00ff"><span style="">	</span>// This is to avoid memory reallocations and thus improve performance.</font></div><div><span style="">	</span><b><font color="#00994d">proxier.filterChains.Reset()</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.filterRules.Reset()</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.natChains.Reset()</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.natRules.Reset()</font></b></div><div><br /></div><div><span style="white-space: pre;">	</span>...<br /></div><div><br /></div><div><span style="">	</span><font color="#7f00ff">// Build rules for each service-port.</font></div><div><span style="">	</span>for svcName, svc := range proxier.serviceMap {</div><div><span style="">		</span>svcInfo, ok := svc.(*serviceInfo)</div><div><span style="">		</span>if !ok {</div><div><span style="">			</span>klog.ErrorS(nil, "Failed to cast serviceInfo", "serviceName", svcName)</div><div><span style="">			</span>continue</div><div><span style="">		</span>}</div><div><span style="">		</span>protocol := strings.ToLower(string(svcInfo.Protocol()))</div><div><span style="">		</span>svcNameString := svcInfo.nameString</div><div><br /></div><div><span style="">		</span>allEndpoints := proxier.endpointsMap[svcName]</div><div><br /></div><div><font color="#7f00ff"><span style="">		</span>// Figure out the endpoints for Cluster and Local traffic policy.</font></div><div><font color="#7f00ff"><span style="">		</span>// allLocallyReachableEndpoints is the set of all endpoints that can be routed to</font></div><div><font color="#7f00ff"><span style="">		</span>// from this node, given the service's traffic policies. hasEndpoints is true</font></div><div><font color="#7f00ff"><span style="">		</span>// if the service has any usable endpoints on any node, not just this one.</font></div><div><span style="">		</span>clusterEndpoints, localEndpoints, allLocallyReachableEndpoints, hasEndpoints := proxy.CategorizeEndpoints(allEndpoints, svcInfo, proxier.nodeLabels)</div><div><br /></div><div><span style="">		</span><font color="#7f00ff">// Generate the per-endpoint chains.</font></div><div><span style="">		</span>for _, ep := range allLocallyReachableEndpoints {</div><div><span style="">			</span>epInfo, ok := ep.(*endpointsInfo)</div><div><span style="">			</span>if !ok {</div><div><span style="">				</span>klog.ErrorS(err, "Failed to cast endpointsInfo", "endpointsInfo", ep)</div><div><span style="">				</span>continue</div><div><span style="">			</span>}</div><div><br /></div><div><span style="">			</span>endpointChain := epInfo.ChainName</div><div><br /></div><div><span style="">			</span><font color="#7f00ff">// Create the endpoint chain, retaining counters if possible.</font></div><div><span style="">			</span>if chain, ok := existingNATChains[endpointChain]; ok {</div><div><span style="">				</span>proxier.natChains.WriteBytes(chain)</div><div><span style="">			</span>} else {</div><div><span style="">				</span>proxier.natChains.Write(utiliptables.MakeChainLine(endpointChain))</div><div><span style="">			</span>}</div><div><span style="">			</span>activeNATChains[endpointChain] = true</div><div><br /></div><div><span style="">			</span>args = append(args[:0], "-A", string(endpointChain))</div><div><span style="">			</span>args = proxier.appendServiceCommentLocked(args, svcNameString)</div><div><span style="">			</span><font color="#7f00ff">// Handle traffic that loops back to the originator with SNAT.</font></div><div><span style="">			</span>proxier.natRules.Write(</div><div><span style="">				</span>args,</div><div><span style="">				</span>"-s", epInfo.IP(),</div><div><span style="">				</span>"-j", string(KubeMarkMasqChain))</div><div><span style="">			</span><font color="#7f00ff">// Update client-affinity lists.</font></div><div><span style="">			</span>if svcInfo.SessionAffinityType() == v1.ServiceAffinityClientIP {</div><div><span style="">				</span>args = append(args, "-m", "recent", "--name", string(endpointChain), "--set")</div><div><span style="">			</span>}</div><div><span style="">			</span><font color="#7f00ff">// DNAT to final destination.</font></div><div><span style="">			</span>args = append(args, "-m", protocol, "-p", protocol, "-j", "DNAT", "--to-destination", epInfo.Endpoint)</div><div><span style="">			</span>proxier.natRules.Write(args)</div><div><span style="">		</span>}</div><div><br /></div><div><span style="white-space: pre;">	</span><span style="white-space: pre;">	</span>...<br /></div><div><br /></div><div><font color="#7f00ff"><span style="">		</span>// If any "external" destinations are enabled, set up external traffic</font></div><div><font color="#7f00ff"><span style="">		</span>// handling.  All captured traffic for all external destinations should</font></div><div><font color="#7f00ff"><span style="">		</span>// jump to externalTrafficChain, which will handle some special-cases</font></div><div><font color="#7f00ff"><span style="">		</span>// and then jump to externalPolicyChain.</font></div><div><span style="">		</span>if hasEndpoints &amp;&amp; svcInfo.ExternallyAccessible() {</div><div><span style="">			</span>if chain, ok := existingNATChains[externalTrafficChain]; ok {</div><div><span style="">				</span>proxier.natChains.WriteBytes(chain)</div><div><span style="">			</span>} else {</div><div><span style="">				</span>proxier.natChains.Write(utiliptables.MakeChainLine(externalTrafficChain))</div><div><span style="">			</span>}</div><div><span style="">			</span>activeNATChains[externalTrafficChain] = true</div><div><br /></div><div><span style="">			</span>if !svcInfo.ExternalPolicyLocal() {</div><div><font color="#7f00ff"><span style="">				</span>// If we are using non-local endpoints we need to masquerade,</font></div><div><font color="#7f00ff"><span style="">				</span>// in case we cross nodes.</font></div><div><span style="">				</span>proxier.natRules.Write(</div><div><span style="">					</span>"-A", string(externalTrafficChain),</div><div><span style="">					</span>"-m", "comment", "--comment", fmt.Sprintf(`"masquerade traffic for %s external destinations"`, svcNameString),</div><div><span style="">					</span>"-j", string(KubeMarkMasqChain))</div><div><span style="">			</span>} else {</div><div><font color="#7f00ff"><span style="">				</span>// If we are only using same-node endpoints, we can retain the</font></div><div><font color="#7f00ff"><span style="">				</span>// source IP in most cases.</font></div><div><br /></div><div><span style="">				</span>if proxier.localDetector.IsImplemented() {</div><div><font color="#7f00ff"><span style="">					</span>// Treat all locally-originated pod -&gt; external destination</font></div><div><font color="#7f00ff"><span style="">					</span>// traffic as a special-case.  It is subject to neither</font></div><div><font color="#7f00ff"><span style="">					</span>// form of traffic policy, which simulates going up-and-out</font></div><div><font color="#7f00ff"><span style="">					</span>// to an external load-balancer and coming back in.</font></div><div><span style="">					</span>proxier.natRules.Write(</div><div><span style="">						</span>"-A", string(externalTrafficChain),</div><div><span style="">						</span>"-m", "comment", "--comment", fmt.Sprintf(`"pod traffic for %s external destinations"`, svcNameString),</div><div><span style="">						</span>proxier.localDetector.IfLocal(),</div><div><span style="">						</span>"-j", string(clusterPolicyChain))</div><div><span style="">				</span>}</div><div><br /></div><div><font color="#7f00ff"><span style="">				</span>// Locally originated traffic (not a pod, but the host node)</font></div><div><font color="#7f00ff"><span style="">				</span>// still needs masquerade because the LBIP itself is a local</font></div><div><font color="#7f00ff"><span style="">				</span>// address, so that will be the chosen source IP.</font></div><div><span style="">				</span>proxier.natRules.Write(</div><div><span style="">					</span>"-A", string(externalTrafficChain),</div><div><span style="">					</span>"-m", "comment", "--comment", fmt.Sprintf(`"masquerade LOCAL traffic for %s external destinations"`, svcNameString),</div><div><span style="">					</span>"-m", "addrtype", "--src-type", "LOCAL",</div><div><span style="">					</span>"-j", string(KubeMarkMasqChain))</div><div><br /></div><div><font color="#7f00ff"><span style="">				</span>// Redirect all src-type=LOCAL -&gt; external destination to the</font></div><div><font color="#7f00ff"><span style="">				</span>// policy=cluster chain. This allows traffic originating</font></div><div><font color="#7f00ff"><span style="">				</span>// from the host to be redirected to the service correctly.</font></div><div><span style="">				</span>proxier.natRules.Write(</div><div><span style="">					</span>"-A", string(externalTrafficChain),</div><div><span style="">					</span>"-m", "comment", "--comment", fmt.Sprintf(`"route LOCAL traffic for %s external destinations"`, svcNameString),</div><div><span style="">					</span>"-m", "addrtype", "--src-type", "LOCAL",</div><div><span style="">					</span>"-j", string(clusterPolicyChain))</div><div><span style="">			</span>}</div><div><br /></div><div><span style="">			</span><font color="#7f00ff">// Anything else falls thru to the appropriate policy chain.</font></div><div><span style="">			</span>proxier.natRules.Write(</div><div><span style="">				</span>"-A", string(externalTrafficChain),</div><div><span style="">				</span>"-j", string(externalPolicyChain))</div><div><span style="">		</span>}</div><div><br /></div><div><span style="">		</span><font color="#7f00ff">// Capture the clusterIP.</font></div><div><span style="">		</span>if hasEndpoints {</div><div><span style="">			</span>args = append(args[:0],</div><div><span style="">				</span>"-m", "comment", "--comment", fmt.Sprintf(`"%s cluster IP"`, svcNameString),</div><div><span style="">				</span>"-m", protocol, "-p", protocol,</div><div><span style="">				</span>"-d", svcInfo.ClusterIP().String(),</div><div><span style="">				</span>"--dport", strconv.Itoa(svcInfo.Port()),</div><div><span style="">			</span>)</div><div><span style="">			</span>if proxier.masqueradeAll {</div><div><span style="">				</span>proxier.natRules.Write(</div><div><span style="">					</span>"-A", string(internalTrafficChain),</div><div><span style="">					</span>args,</div><div><span style="">					</span>"-j", string(KubeMarkMasqChain))</div><div><span style="">			</span>} else if proxier.localDetector.IsImplemented() {</div><div><font color="#7f00ff"><span style="">				</span>// This masquerades off-cluster traffic to a service VIP.  The idea</font></div><div><font color="#7f00ff"><span style="">				</span>// is that you can establish a static route for your Service range,</font></div><div><font color="#7f00ff"><span style="">				</span>// routing to any node, and that node will bridge into the Service</font></div><div><font color="#7f00ff"><span style="">				</span>// for you.  Since that might bounce off-node, we masquerade here.</font></div><div><span style="">				</span>proxier.natRules.Write(</div><div><span style="">					</span>"-A", string(internalTrafficChain),</div><div><span style="">					</span>args,</div><div><span style="">					</span>proxier.localDetector.IfNotLocal(),</div><div><span style="">					</span>"-j", string(KubeMarkMasqChain))</div><div><span style="">			</span>}</div><div><span style="">			</span>proxier.natRules.Write(</div><div><span style="">				</span>"-A", string(kubeServicesChain),</div><div><span style="">				</span>args,</div><div><span style="">				</span>"-j", string(internalTrafficChain))</div><div><span style="">		</span>} else {</div><div><span style="">			</span><font color="#7f00ff">// No endpoints.</font></div><div><span style="">			</span>proxier.filterRules.Write(</div><div><span style="">				</span>"-A", string(kubeServicesChain),</div><div><span style="">				</span>"-m", "comment", "--comment", fmt.Sprintf(`"%s has no endpoints"`, svcNameString),</div><div><span style="">				</span>"-m", protocol, "-p", protocol,</div><div><span style="">				</span>"-d", svcInfo.ClusterIP().String(),</div><div><span style="">				</span>"--dport", strconv.Itoa(svcInfo.Port()),</div><div><span style="">				</span>"-j", "REJECT",</div><div><span style="">			</span>)</div><div><span style="">		</span>}</div><div><br /></div><div><span style="">		</span><font color="#7f00ff">// Capture externalIPs.</font></div><div><span style="">		</span>for _, externalIP := range svcInfo.ExternalIPStrings() {</div><div><span style="">			</span>if hasEndpoints {</div><div><font color="#7f00ff"><span style="">				</span>// Send traffic bound for external IPs to the "external</font></div><div><font color="#7f00ff"><span style="">				</span>// destinations" chain.</font></div><div><span style="">				</span>proxier.natRules.Write(</div><div><span style="">					</span>"-A", string(kubeServicesChain),</div><div><span style="">					</span>"-m", "comment", "--comment", fmt.Sprintf(`"%s external IP"`, svcNameString),</div><div><span style="">					</span>"-m", protocol, "-p", protocol,</div><div><span style="">					</span>"-d", externalIP,</div><div><span style="">					</span>"--dport", strconv.Itoa(svcInfo.Port()),</div><div><span style="">					</span>"-j", string(externalTrafficChain))</div><div><br /></div><div><span style="">			</span>} else {</div><div><span style="">				</span><font color="#7f00ff">// No endpoints.</font></div><div><span style="">				</span>proxier.filterRules.Write(</div><div><span style="">					</span>"-A", string(kubeExternalServicesChain),</div><div><span style="">					</span>"-m", "comment", "--comment", fmt.Sprintf(`"%s has no endpoints"`, svcNameString),</div><div><span style="">					</span>"-m", protocol, "-p", protocol,</div><div><span style="">					</span>"-d", externalIP,</div><div><span style="">					</span>"--dport", strconv.Itoa(svcInfo.Port()),</div><div><span style="">					</span>"-j", "REJECT",</div><div><span style="">				</span>)</div><div><span style="">			</span>}</div><div><span style="">		</span>}</div><div><br /></div><div><span style="">		</span><font color="#7f00ff">// Capture load-balancer ingress.</font></div><div><span style="">		</span>if len(svcInfo.LoadBalancerIPStrings()) &gt; 0 &amp;&amp; hasEndpoints {</div><div><span style="">			</span><font color="#7f00ff">// Normally we send LB matches to the "external destination" chain.</font></div><div><span style="">			</span>nextChain := externalTrafficChain</div><div><br /></div><div><font color="#7f00ff"><span style="">			</span>// If the service specifies any LB source ranges, we need to insert</font></div><div><font color="#7f00ff"><span style="">			</span>// a firewall chain first.</font></div><div><span style="">			</span>if len(svcInfo.LoadBalancerSourceRanges()) &gt; 0 {</div><div><span style="">				</span>fwChain := svcInfo.firewallChainName</div><div><br /></div><div><span style="">				</span><font color="#7f00ff">// Declare the service firewall chain.</font></div><div><span style="">				</span>if chain, ok := existingNATChains[fwChain]; ok {</div><div><span style="">					</span>proxier.natChains.WriteBytes(chain)</div><div><span style="">				</span>} else {</div><div><span style="">					</span>proxier.natChains.Write(utiliptables.MakeChainLine(fwChain))</div><div><span style="">				</span>}</div><div><span style="">				</span>activeNATChains[fwChain] = true</div><div><br /></div><div><font color="#7f00ff"><span style="">				</span>// The firewall chain will jump to the "external destination"</font></div><div><font color="#7f00ff"><span style="">				</span>// chain.</font></div><div><span style="">				</span>nextChain = svcInfo.firewallChainName</div><div><span style="">			</span>}</div><div><br /></div><div><span style="">			</span>for _, lbip := range svcInfo.LoadBalancerIPStrings() {</div><div><span style="">				</span>proxier.natRules.Write(</div><div><span style="">					</span>"-A", string(kubeServicesChain),</div><div><span style="">					</span>"-m", "comment", "--comment", fmt.Sprintf(`"%s loadbalancer IP"`, svcNameString),</div><div><span style="">					</span>"-m", protocol, "-p", protocol,</div><div><span style="">					</span>"-d", lbip,</div><div><span style="">					</span>"--dport", strconv.Itoa(svcInfo.Port()),</div><div><span style="">					</span>"-j", string(nextChain))</div><div><br /></div><div><font color="#7f00ff"><span style="">				</span>// The service firewall rules are created based on the</font></div><div><font color="#7f00ff"><span style="">				</span>// loadBalancerSourceRanges field.  This only works for</font></div><div><font color="#7f00ff"><span style="">				</span>// VIP-like loadbalancers that preserve source IPs.  For</font></div><div><font color="#7f00ff"><span style="">				</span>// loadbalancers which direct traffic to service NodePort, the</font></div><div><font color="#7f00ff"><span style="">				</span>// firewall rules will not apply.</font></div><div><span style="">				</span>if len(svcInfo.LoadBalancerSourceRanges()) &gt; 0 {</div><div><span style="">					</span>args = append(args[:0],</div><div><span style="">						</span>"-A", string(nextChain),</div><div><span style="">						</span>"-m", "comment", "--comment", fmt.Sprintf(`"%s loadbalancer IP"`, svcNameString),</div><div><span style="">					</span>)</div><div><br /></div><div><span style="">					</span><font color="#7f00ff">// firewall filter based on each source range</font></div><div><span style="">					</span>allowFromNode := false</div><div><span style="">					</span>for _, src := range svcInfo.LoadBalancerSourceRanges() {</div><div><span style="">						</span>proxier.natRules.Write(args, "-s", src, "-j", string(externalTrafficChain))</div><div><span style="">						</span>_, cidr, err := netutils.ParseCIDRSloppy(src)</div><div><span style="">						</span>if err != nil {</div><div><span style="">							</span>klog.ErrorS(err, "Error parsing CIDR in LoadBalancerSourceRanges, dropping it", "cidr", cidr)</div><div><span style="">						</span>} else if cidr.Contains(proxier.nodeIP) {</div><div><span style="">							</span>allowFromNode = true</div><div><span style="">						</span>}</div><div><span style="">					</span>}</div><div><font color="#7f00ff"><span style="">					</span>// For VIP-like LBs, the VIP is often added as a local</font></div><div><font color="#7f00ff"><span style="">					</span>// address (via an IP route rule).  In that case, a request</font></div><div><font color="#7f00ff"><span style="">					</span>// from a node to the VIP will not hit the loadbalancer but</font></div><div><font color="#7f00ff"><span style="">					</span>// will loop back with the source IP set to the VIP.  We</font></div><div><font color="#7f00ff"><span style="">					</span>// need the following rule to allow requests from this node.</font></div><div><span style="">					</span>if allowFromNode {</div><div><span style="">						</span>proxier.natRules.Write(</div><div><span style="">							</span>args,</div><div><span style="">							</span>"-s", lbip,</div><div><span style="">							</span>"-j", string(externalTrafficChain))</div><div><span style="">					</span>}</div><div><font color="#7f00ff"><span style="">					</span>// If the packet was able to reach the end of firewall chain,</font></div><div><font color="#7f00ff"><span style="">					</span>// then it did not get DNATed.  It means the packet cannot go</font></div><div><font color="#7f00ff"><span style="">					</span>// thru the firewall, then mark it for DROP.</font></div><div><span style="">					</span>proxier.natRules.Write(args, "-j", string(KubeMarkDropChain))</div><div><span style="">				</span>}</div><div><span style="">			</span>}</div><div><span style="">		</span>} else {</div><div><span style="">			</span><font color="#7f00ff">// No endpoints.</font></div><div><span style="">			</span>for _, lbip := range svcInfo.LoadBalancerIPStrings() {</div><div><span style="">				</span>proxier.filterRules.Write(</div><div><span style="">					</span>"-A", string(kubeExternalServicesChain),</div><div><span style="">					</span>"-m", "comment", "--comment", fmt.Sprintf(`"%s has no endpoints"`, svcNameString),</div><div><span style="">					</span>"-m", protocol, "-p", protocol,</div><div><span style="">					</span>"-d", lbip,</div><div><span style="">					</span>"--dport", strconv.Itoa(svcInfo.Port()),</div><div><span style="">					</span>"-j", "REJECT",</div><div><span style="">				</span>)</div><div><span style="">			</span>}</div><div><span style="">		</span>}</div><div><br /></div><div><span style="">		</span><font color="#7f00ff">// Capture nodeports.</font></div><div><span style="">		</span>if svcInfo.NodePort() != 0 &amp;&amp; len(nodeAddresses) != 0 {</div><div><span style="">			</span>if hasEndpoints {</div><div><font color="#7f00ff"><span style="">				</span>// Jump to the external destination chain.  For better or for</font></div><div><font color="#7f00ff"><span style="">				</span>// worse, nodeports are not subect to loadBalancerSourceRanges,</font></div><div><font color="#7f00ff"><span style="">				</span>// and we can't change that.</font></div><div><span style="">				</span>proxier.natRules.Write(</div><div><span style="">					</span>"-A", string(kubeNodePortsChain),</div><div><span style="">					</span>"-m", "comment", "--comment", svcNameString,</div><div><span style="">					</span>"-m", protocol, "-p", protocol,</div><div><span style="">					</span>"--dport", strconv.Itoa(svcInfo.NodePort()),</div><div><span style="">					</span>"-j", string(externalTrafficChain))</div><div><span style="">			</span>} else {</div><div><span style="">				</span><font color="#7f00ff">// No endpoints.</font></div><div><span style="">				</span>proxier.filterRules.Write(</div><div><span style="">					</span>"-A", string(kubeExternalServicesChain),</div><div><span style="">					</span>"-m", "comment", "--comment", fmt.Sprintf(`"%s has no endpoints"`, svcNameString),</div><div><span style="">					</span>"-m", "addrtype", "--dst-type", "LOCAL",</div><div><span style="">					</span>"-m", protocol, "-p", protocol,</div><div><span style="">					</span>"--dport", strconv.Itoa(svcInfo.NodePort()),</div><div><span style="">					</span>"-j", "REJECT",</div><div><span style="">				</span>)</div><div><span style="">			</span>}</div><div><span style="">		</span>}</div><div><br /></div><div><span style="">		</span><font color="#7f00ff">// Capture healthCheckNodePorts.</font></div><div><span style="">		</span>if svcInfo.HealthCheckNodePort() != 0 {</div><div><font color="#7f00ff"><span style="">			</span>// no matter if node has local endpoints, healthCheckNodePorts</font></div><div><font color="#7f00ff"><span style="">			</span>// need to add a rule to accept the incoming connection</font></div><div><span style="">			</span>proxier.filterRules.Write(</div><div><span style="">				</span>"-A", string(kubeNodePortsChain),</div><div><span style="">				</span>"-m", "comment", "--comment", fmt.Sprintf(`"%s health check node port"`, svcNameString),</div><div><span style="">				</span>"-m", "tcp", "-p", "tcp",</div><div><span style="">				</span>"--dport", strconv.Itoa(svcInfo.HealthCheckNodePort()),</div><div><span style="">				</span>"-j", "ACCEPT",</div><div><span style="">			</span>)</div><div><span style="">		</span>}</div><div><br /></div><div><span style="">		</span>if svcInfo.UsesClusterEndpoints() {</div><div><span style="">			</span><font color="#7f00ff">// Write rules jumping from clusterPolicyChain to clusterEndpoints</font></div><div><span style="">			</span>proxier.writeServiceToEndpointRules(svcNameString, svcInfo, clusterPolicyChain, clusterEndpoints, args)</div><div><span style="">		</span>}</div><div><br /></div><div><span style="">		</span>if svcInfo.UsesLocalEndpoints() {</div><div><span style="">			</span>if len(localEndpoints) != 0 {</div><div><span style="">				</span><font color="#7f00ff">// Write rules jumping from localPolicyChain to localEndpointChains</font></div><div><span style="">				</span>proxier.writeServiceToEndpointRules(svcNameString, svcInfo, localPolicyChain, localEndpoints, args)</div><div><span style="">			</span>} else {</div><div><span style="">				</span>if svcInfo.InternalPolicyLocal() &amp;&amp; utilfeature.DefaultFeatureGate.Enabled(features.ServiceInternalTrafficPolicy) {</div><div><span style="">					</span>serviceNoLocalEndpointsTotalInternal++</div><div><span style="">				</span>}</div><div><span style="">				</span>if svcInfo.ExternalPolicyLocal() {</div><div><span style="">					</span>serviceNoLocalEndpointsTotalExternal++</div><div><span style="">				</span>}</div><div><span style="">				</span>if hasEndpoints {</div><div><span style="">					</span><font color="#7f00ff">// Blackhole all traffic since there are no local endpoints</font></div><div><span style="">					</span>args = append(args[:0],</div><div><span style="">						</span>"-A", string(localPolicyChain),</div><div><span style="">						</span>"-m", "comment", "--comment",</div><div><span style="">						</span>fmt.Sprintf(`"%s has no local endpoints"`, svcNameString),</div><div><span style="">						</span>"-j",</div><div><span style="">						</span>string(KubeMarkDropChain),</div><div><span style="">					</span>)</div><div><span style="">					</span>proxier.natRules.Write(args)</div><div><span style="">				</span>}</div><div><span style="">			</span>}</div><div><span style="">		</span>}</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span><font color="#7f00ff">// Delete chains no longer in use.</font></div><div><span style="">	</span>for chain := range existingNATChains {</div><div><span style="">		</span>if !activeNATChains[chain] {</div><div><span style="">			</span>chainString := string(chain)</div><div><span style="">			</span>if !isServiceChainName(chainString) {</div><div><span style="">				</span><font color="#7f00ff">// Ignore chains that aren't ours.</font></div><div><span style="">				</span>continue</div><div><span style="">			</span>}</div><div><font color="#7f00ff"><span style="">			</span>// We must (as per iptables) write a chain-line for it, which has</font></div><div><font color="#7f00ff"><span style="">			</span>// the nice effect of flushing the chain.  Then we can remove the</font></div><div><font color="#7f00ff"><span style="">			</span>// chain.</font></div><div><span style="">			</span>proxier.natChains.WriteBytes(existingNATChains[chain])</div><div><span style="">			</span>proxier.natRules.Write("-X", chainString)</div><div><span style="">		</span>}</div><div><span style="">	</span>}</div><div><br /></div><div><font color="#7f00ff"><span style="">	</span>// Finally, tail-call to the nodeports chain.  This needs to be after all</font></div><div><font color="#7f00ff"><span style="">	</span>// other service portal rules.</font></div><div><span style="">	</span>for address := range nodeAddresses {</div><div><span style="">		</span>if utilproxy.IsZeroCIDR(address) {</div><div><span style="">			</span>proxier.natRules.Write(</div><div><span style="">				</span>"-A", string(kubeServicesChain),</div><div><span style="">				</span>"-m", "comment", "--comment", `"kubernetes service nodeports; NOTE: this must be the last rule in this chain"`,</div><div><span style="">				</span>"-m", "addrtype", "--dst-type", "LOCAL",</div><div><span style="">				</span>"-j", string(kubeNodePortsChain))</div><div><span style="">			</span><font color="#7f00ff">// Nothing else matters after the zero CIDR</font>.</div><div><span style="">			</span>break</div><div><span style="">		</span>}</div><div><span style="">		</span><font color="#7f00ff">// Ignore IP addresses with incorrect version</font></div><div><span style="">		</span>if isIPv6 &amp;&amp; !netutils.IsIPv6String(address) || !isIPv6 &amp;&amp; netutils.IsIPv6String(address) {</div><div><span style="">			</span>klog.ErrorS(nil, "IP has incorrect IP version", "IP", address)</div><div><span style="">			</span>continue</div><div><span style="">		</span>}</div><div><span style="">		</span><font color="#7f00ff">// create nodeport rules for each IP one by one</font></div><div><span style="">		</span>proxier.natRules.Write(</div><div><span style="">			</span>"-A", string(kubeServicesChain),</div><div><span style="">			</span>"-m", "comment", "--comment", `"kubernetes service nodeports; NOTE: this must be the last rule in this chain"`,</div><div><span style="">			</span>"-d", address,</div><div><span style="">			</span>"-j", string(kubeNodePortsChain))</div><div><span style="">	</span>}</div><div><br /></div><div><font color="#7f00ff"><span style="">	</span>// Drop the packets in INVALID state, which would potentially cause</font></div><div><font color="#7f00ff"><span style="">	</span>// unexpected connection reset.</font></div><div><font color="#7f00ff"><span style="">	</span>// https://github.com/kubernetes/kubernetes/issues/74839</font></div><div><span style="">	</span>proxier.filterRules.Write(</div><div><span style="">		</span>"-A", string(kubeForwardChain),</div><div><span style="">		</span>"-m", "conntrack",</div><div><span style="">		</span>"--ctstate", "INVALID",</div><div><span style="">		</span>"-j", "DROP",</div><div><span style="">	</span>)</div><div><br /></div><div><font color="#7f00ff"><span style="">	</span>// If the masqueradeMark has been added then we want to forward that same</font></div><div><font color="#7f00ff"><span style="">	</span>// traffic, this allows NodePort traffic to be forwarded even if the default</font></div><div><font color="#7f00ff"><span style="">	</span>// FORWARD policy is not accept.</font></div><div><span style="">	</span>proxier.filterRules.Write(</div><div><span style="">		</span>"-A", string(kubeForwardChain),</div><div><span style="">		</span>"-m", "comment", "--comment", `"kubernetes forwarding rules"`,</div><div><span style="">		</span>"-m", "mark", "--mark", fmt.Sprintf("%s/%s", proxier.masqueradeMark, proxier.masqueradeMark),</div><div><span style="">		</span>"-j", "ACCEPT",</div><div><span style="">	</span>)</div><div><br /></div><div><font color="#7f00ff"><span style="">	</span>// The following rule ensures the traffic after the initial packet accepted</font></div><div><font color="#7f00ff"><span style="">	</span>// by the "kubernetes forwarding rules" rule above will be accepted.</font></div><div><span style="">	</span>proxier.filterRules.Write(</div><div><span style="">		</span>"-A", string(kubeForwardChain),</div><div><span style="">		</span>"-m", "comment", "--comment", `"kubernetes forwarding conntrack rule"`,</div><div><span style="">		</span>"-m", "conntrack",</div><div><span style="">		</span>"--ctstate", "RELATED,ESTABLISHED",</div><div><span style="">		</span>"-j", "ACCEPT",</div><div><span style="">	</span>)</div><div><br /></div><div><span style="">	</span>metrics.IptablesRulesTotal.WithLabelValues(string(utiliptables.TableFilter)).Set(float64(proxier.filterRules.Lines()))</div><div><span style="">	</span>metrics.IptablesRulesTotal.WithLabelValues(string(utiliptables.TableNAT)).Set(float64(proxier.natRules.Lines()))</div><div><br /></div><div><span style="">	</span><font color="#7f00ff">// Sync rules.</font></div><div><span style="">	</span><b><font color="#00994d">proxier.iptablesData.Reset()</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.iptablesData.WriteString("*filter\n")</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.iptablesData.Write(proxier.filterChains.Bytes())</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.iptablesData.Write(proxier.filterRules.Bytes())</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.iptablesData.WriteString("COMMIT\n")</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.iptablesData.WriteString("*nat\n")</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.iptablesData.Write(proxier.natChains.Bytes())</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.iptablesData.Write(proxier.natRules.Bytes())</font></b></div><div><span style="">	</span><b><font color="#00994d">proxier.iptablesData.WriteString("COMMIT\n")</font></b></div><div><br /></div><div><span style="">	</span>klog.V(2).InfoS("Reloading service iptables data",</div><div><span style="">		</span>"numServices", len(proxier.serviceMap),</div><div><span style="">		</span>"numEndpoints", proxier.endpointChainsNumber,</div><div><span style="">		</span>"numFilterChains", proxier.filterChains.Lines(),</div><div><span style="">		</span>"numFilterRules", proxier.filterRules.Lines(),</div><div><span style="">		</span>"numNATChains", proxier.natChains.Lines(),</div><div><span style="">		</span>"numNATRules", proxier.natRules.Lines(),</div><div><span style="">	</span>)</div><div><span style="">	</span>klog.V(9).InfoS("Restoring iptables", "rules", proxier.iptablesData.Bytes())</div><div><br /></div><div><span style="">	</span><font color="#7f00ff">// NOTE: NoFlushTables is used so we don't flush non-kubernetes chains in the table</font></div><div><span style="">	</span>err = <b><font color="#00994d">proxier.iptables.RestoreAll(proxier.iptablesData.Bytes(), utiliptables.NoFlushTables, utiliptables.RestoreCounters)</font></b></div><div><span style="">	</span>if err != nil {</div><div><span style="">		</span>if pErr, ok := err.(utiliptables.ParseError); ok {</div><div><span style="">			</span>lines := utiliptables.ExtractLines(proxier.iptablesData.Bytes(), pErr.Line(), 3)</div><div><span style="">			</span>klog.ErrorS(pErr, "Failed to execute iptables-restore", "rules", lines)</div><div><span style="">		</span>} else {</div><div><span style="">			</span>klog.ErrorS(err, "Failed to execute iptables-restore")</div><div><span style="">		</span>}</div><div><span style="">		</span>metrics.IptablesRestoreFailuresTotal.Inc()</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><span style="">	</span>success = true</div><div><span style="white-space: pre;">	</span>...<br /></div><div>}</div></pre></div></div></div></foreignObject><text x="383" y="5687" fill="#000000" font-family="Helvetica" font-size="12px">// This is where all of the iptables-save/restore calls happen....</text></switch></g><path d="M 881 2060 L 881 2093.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 881 2098.88 L 877.5 2091.88 L 881 2093.63 L 884.5 2091.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.diagrams.net/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg>