<?xml version="1.0" encoding="UTF-8"?>
<!-- Do not edit this file with editors other than diagrams.net -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="3261px" height="3290px" viewBox="-0.5 -0.5 3261 3290" content="&lt;mxfile host=&quot;Electron&quot; modified=&quot;2022-08-19T08:01:26.310Z&quot; agent=&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/19.0.3 Chrome/102.0.5005.63 Electron/19.0.3 Safari/537.36&quot; etag=&quot;QCzm1LxoaPib6bpzLciy&quot; version=&quot;19.0.3&quot; type=&quot;device&quot;&gt;&lt;diagram id=&quot;pJl5-mdczoil5iY8ySmy&quot; name=&quot;第 1 页&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;" style="background-color: rgb(255, 255, 255);"><defs/><g><path d="M 1090 23 L 1090 0 L 1670 0 L 1670 23" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/><path d="M 1090 23 L 1090 240 L 1670 240 L 1670 23" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1090 23 L 1670 23" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="rgb(0, 0, 0)" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="1379.5" y="16">Run (cmd/kube-apiserver/app/server.go)</text></g><rect x="1090" y="20" width="580" height="220" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 578px; height: 1px; padding-top: 130px; margin-left: 1092px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><font color="#7f00ff">// Run runs the specified APIServer.  This should never exit.</font><div><b>func Run(completeOptions completedServerRunOptions, stopCh &lt;-chan struct{})</b> error {</div><div><span style="white-space: pre;">	</span>...<br /></div><div><span style="">	</span>server, err := CreateServerChain(completeOptions, stopCh)</div><div><span style="">	</span>if err != nil {</div><div><span style="">		</span>return err</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span><b><font color="#00994d">prepared, err := server.PrepareRun()</font></b></div><div><span style="">	</span>if err != nil {</div><div><span style="">		</span>return err</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>return <b><font color="#00994d">prepared.Run(stopCh)</font></b></div><div>}</div></pre></div></div></div></foreignObject><text x="1092" y="134" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px">// Run runs the specified APIServer.  This should never exit....</text></switch></g><path d="M 950 303 L 950 280 L 1810 280 L 1810 303" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 950 303 L 950 750 L 1810 750 L 1810 303" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 950 303 L 1810 303" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="1379.5" y="296">PrepareRun (staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go)</text></g><rect x="950" y="303" width="860" height="450" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 858px; height: 1px; padding-top: 528px; margin-left: 952px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><font color="#7f00ff">// PrepareRun does post API installation setup steps. It calls recursively the same function of the delegates.</font><div><b>func (s *GenericAPIServer) PrepareRun() preparedGenericAPIServer</b> {</div><div><span style="white-space: pre;">	</span><font color="#7f00ff">// call previous server's PrepareRun in the delegate chain</font><br /></div><div><span style="">	</span><b><font color="#00994d">s.delegationTarget.PrepareRun()</font></b></div><div><span style="white-space: pre;">	</span>...<br /></div><div><span style="white-space: pre;">	</span><font color="#7f00ff">// install Healthz, Livez handlers</font><br /></div><div><b><font color="#00994d"><span style="">	</span>s.installHealthz()</font></b></div><div><b><font color="#00994d"><span style="">	</span>s.installLivez()</font></b></div><div><br /></div><div><span style="">	</span><font color="#7f00ff">// as soon as shutdown is initiated, readiness should start failing</font></div><div><span style="">	</span>readinessStopCh := s.lifecycleSignals.ShutdownInitiated.Signaled()</div><div><span style="">	</span>err := s.addReadyzShutdownCheck(readinessStopCh)</div><div><span style="">	</span>if err != nil {</div><div><span style="">		</span>klog.Errorf("Failed to install readyz shutdown check %s", err)</div><div><span style="">	</span>}</div><div><span style="">	</span><b><font color="#00994d">s.installReadyz()</font></b></div><div><br /></div><div><span style="">	</span><font color="#7f00ff">// Register audit backend preShutdownHook.</font></div><div><span style="">	</span>if s.AuditBackend != nil {</div><div><span style="">		</span>err := s.AddPreShutdownHook("audit-backend", func() error {</div><div><span style="">			</span>s.AuditBackend.Shutdown()</div><div><span style="">			</span>return nil</div><div><span style="">		</span>})</div><div><span style="">		</span>if err != nil {</div><div><span style="">			</span>klog.Errorf("Failed to add pre-shutdown hook for audit-backend %s", err)</div><div><span style="">		</span>}</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>return preparedGenericAPIServer{s}</div><div>}</div></pre></div></div></div></foreignObject><text x="952" y="532" fill="#000000" font-family="Helvetica" font-size="12px">// PrepareRun does post API installation setup steps. It calls recursively the same function of the delegates....</text></switch></g><path d="M 1035 813 L 1035 790 L 1725 790 L 1725 813" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1035 813 L 1035 1240 L 1725 1240 L 1725 813" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1035 813 L 1725 813" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="1379.5" y="806">Run (staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go)</text></g><rect x="1035" y="810" width="690" height="430" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 688px; height: 1px; padding-top: 1025px; margin-left: 1037px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><font color="#7f00ff">// Run spawns the secure http server. It only returns if stopCh is closed</font><div><font color="#7f00ff">// or the secure port cannot be listened on initially.</font></div><div><b>func (s preparedGenericAPIServer) Run(stopCh &lt;-chan struct{})</b> error {</div><div><span style="white-space: pre;">	</span>...<br /></div><div><span style="white-space: pre;">	</span><font color="#7f00ff">// run http server</font><br /></div><div><span style="">	</span><b><font color="#00994d">stoppedCh, listenerStoppedCh, err := s.NonBlockingRun(stopHttpServerCh, shutdownTimeout)</font></b></div><div><span style="">	</span>if err != nil {</div><div><span style="">		</span>return err</div><div><span style="">	</span>}</div><div><span style="white-space: pre;">	</span>...<br /></div><div><br /></div><div><span style="">	</span>klog.V(1).Info("[graceful-termination] waiting for shutdown to be initiated")</div><div><span style="">	</span>&lt;-stopCh</div><div><br /></div><div><font color="#7f00ff"><span style="">	</span>// run shutdown hooks directly. This includes deregistering from</font></div><div><font color="#7f00ff"><span style="">	</span>// the kubernetes endpoint in case of kube-apiserver.</font></div><div><span style="">	</span>func() {</div><div><span style="">		</span>defer close(preShutdownHooksHasStoppedCh)</div><div><span style="">		</span>err = s.RunPreShutdownHooks()</div><div><span style="">	</span>}()</div><div><span style="">	</span>if err != nil {</div><div><span style="">		</span>return err</div><div><span style="">	</span>}</div><div><span style="">	</span>klog.V(1).Info("[graceful-termination] RunPreShutdownHooks has completed")</div><div><span style="white-space: pre;">	</span>...<br /></div><div><br /></div><div><span style="">	</span>klog.V(1).Info("[graceful-termination] apiserver is exiting")</div><div><span style="">	</span>return nil</div><div>}</div></pre></div></div></div></foreignObject><text x="1037" y="1029" fill="#000000" font-family="Helvetica" font-size="12px">// Run spawns the secure http server. It only returns if stopCh is closed...</text></switch></g><path d="M 905 1303 L 905 1280 L 1855 1280 L 1855 1303" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 905 1303 L 905 1920 L 1855 1920 L 1855 1303" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 905 1303 L 1855 1303" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="1379.5" y="1296">NonBlockingRun (staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go)</text></g><rect x="904" y="1300" width="951" height="620" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 949px; height: 1px; padding-top: 1610px; margin-left: 906px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><font color="#7f00ff">// NonBlockingRun spawns the secure http server. An error is</font><div><font color="#7f00ff">// returned if the secure port cannot be listened on.</font></div><div><font color="#7f00ff">// The returned channel is closed when the (asynchronous) termination is finished.</font></div><div><b>func (s preparedGenericAPIServer) NonBlockingRun</b>(stopCh &lt;-chan struct{}, shutdownTimeout time.Duration) (&lt;-chan struct{}, &lt;-chan struct{}, error) {</div><div><font color="#7f00ff"><span style="">	</span>// Use an stop channel to allow graceful shutdown without dropping audit events</font></div><div><font color="#7f00ff"><span style="">	</span>// after http server shutdown.</font></div><div><span style="">	</span>auditStopCh := make(chan struct{})</div><div><br /></div><div><font color="#7f00ff"><span style="">	</span>// Start the audit backend before any request comes in. This means we must call Backend.Run</font></div><div><font color="#7f00ff"><span style="">	</span>// before http server start serving. Otherwise the Backend.ProcessEvents call might block.</font></div><div><span style="">	</span>if s.AuditBackend != nil {</div><div><span style="">		</span>if err := s.AuditBackend.Run(auditStopCh); err != nil {</div><div><span style="">			</span>return nil, nil, fmt.Errorf("failed to run the audit backend: %v", err)</div><div><span style="">		</span>}</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span><font color="#7f00ff">// Use an internal stop channel to allow cleanup of the listeners on error.</font></div><div><span style="">	</span>internalStopCh := make(chan struct{})</div><div><span style="">	</span>var stoppedCh &lt;-chan struct{}</div><div><span style="">	</span>var listenerStoppedCh &lt;-chan struct{}</div><div><span style="">	</span>if s.SecureServingInfo != nil &amp;&amp; s.Handler != nil {</div><div><span style="">		</span>var err error</div><div><span style="white-space: pre;">	</span><span style="white-space: pre;">	</span><font color="#7f00ff">// run http server (staging/src/k8s.io/pkg/server/secure_serving.go)</font><br /></div><div><font color="#7f00ff"><span style="white-space: pre;">	</span><span style="white-space: pre;">	</span>// handle http requests in ServeHTTP<br /></font></div><div><span style="">		</span><b><font color="#00994d">stoppedCh, listenerStoppedCh, err = s.SecureServingInfo.Serve(s.Handler, shutdownTimeout, internalStopCh)</font></b></div><div><span style="">		</span>if err != nil {</div><div><span style="">			</span>close(internalStopCh)</div><div><span style="">			</span>close(auditStopCh)</div><div><span style="">			</span>return nil, nil, err</div><div><span style="">		</span>}</div><div><span style="">	</span>}</div><div><span style="white-space: pre;">	</span>...<br /></div><div><br /></div><div><span style="">	</span><b><font color="#00994d">s.RunPostStartHooks(stopCh)</font></b></div><div><br /></div><div><span style="white-space: pre;">	</span><font color="#7f00ff">// notify systemd</font><br /></div><div><span style="">	</span>if _, err := <b><font color="#00994d">systemd.SdNotify</font></b>(true, "READY=1\n"); err != nil {</div><div><span style="">		</span>klog.Errorf("Unable to send systemd daemon successful start message: %v\n", err)</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>return stoppedCh, listenerStoppedCh, nil</div><div>}</div></pre></div></div></div></foreignObject><text x="906" y="1614" fill="#000000" font-family="Helvetica" font-size="12px">// NonBlockingRun spawns the secure http server. An error is...</text></switch></g><path d="M 955 1983 L 955 1960 L 1805 1960 L 1805 1983" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 955 1983 L 955 2870 L 1805 2870 L 1805 1983" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 955 1983 L 1805 1983" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="1379.5" y="1976">ServeHTTP (staging/src/k8s.io/kube-aggregator/pkg/apiserver/handler_proxy.go)</text></g><rect x="955" y="1980" width="850" height="890" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 848px; height: 1px; padding-top: 2425px; margin-left: 957px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><b>func (r *proxyHandler) ServeHTTP(w http.ResponseWriter, req *http.Request)</b> {<div><span style="">	</span>value := r.handlingInfo.Load()</div><div><span style="">	</span>if value == nil {</div><div><span style="white-space: pre;">	</span><span style="white-space: pre;">	</span><font color="#7f00ff">// handle local api</font><br /></div><div><span style="">		</span><b><font color="#00994d">r.localDelegate.ServeHTTP(w, req)</font></b></div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><span style="">	</span>handlingInfo := value.(proxyHandlingInfo)</div><div><span style="">	</span>if handlingInfo.local {</div><div><span style="">		</span>if r.localDelegate == nil {</div><div><span style="">			</span>http.Error(w, "", http.StatusNotFound)</div><div><span style="">			</span>return</div><div><span style="">		</span>}</div><div><span style="white-space: pre;">	</span><span style="white-space: pre;">	</span><font color="#7f00ff">// handle local api</font><br /></div><div><span style="">		</span><b><font color="#00994d">r.localDelegate.ServeHTTP(w, req)</font></b></div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><span style="white-space: pre;">	</span>...<br /></div><div><br /></div><div><span style="">	</span>user, ok := genericapirequest.UserFrom(req.Context())</div><div><span style="">	</span>if !ok {</div><div><span style="">		</span>proxyError(w, req, "missing user", http.StatusInternalServerError)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span><font color="#7f00ff">// write a new location based on the existing request pointed at the target service</font></div><div><span style="">	</span>location := &amp;url.URL{}</div><div><span style="">	</span>location.Scheme = "https"</div><div><span style="">	</span>rloc, err := r.serviceResolver.ResolveEndpoint(handlingInfo.serviceNamespace, handlingInfo.serviceName, handlingInfo.servicePort)</div><div><span style="">	</span>if err != nil {</div><div><span style="">		</span>klog.Errorf("error resolving %s/%s: %v", handlingInfo.serviceNamespace, handlingInfo.serviceName, err)</div><div><span style="">		</span>proxyError(w, req, "service unavailable", http.StatusServiceUnavailable)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><span style="">	</span>location.Host = rloc.Host</div><div><span style="">	</span>location.Path = req.URL.Path</div><div><span style="">	</span>location.RawQuery = req.URL.Query().Encode()</div><div><br /></div><div><span style="">	</span><b><font color="#00994d">newReq, cancelFn := newRequestForProxy(location, req)</font></b></div><div><span style="">	</span>defer cancelFn()</div><div><br /></div><div><span style="">	</span>if handlingInfo.proxyRoundTripper == nil {</div><div><span style="">		</span>proxyError(w, req, "", http.StatusNotFound)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>proxyRoundTripper := handlingInfo.proxyRoundTripper</div><div><span style="">	</span>upgrade := httpstream.IsUpgradeRequest(req)</div><div><br /></div><div><span style="">	</span>proxyRoundTripper = transport.NewAuthProxyRoundTripper(user.GetName(), user.GetGroups(), user.GetExtra(), proxyRoundTripper)</div><div><br /></div><div><font color="#7f00ff"><span style="">	</span>// If we are upgrading, then the upgrade path tries to use this request with the TLS config we provide, but it does</font></div><div><font color="#7f00ff"><span style="">	</span>// NOT use the proxyRoundTripper.  It's a direct dial that bypasses the proxyRoundTripper.  This means that we have to</font></div><div><font color="#7f00ff"><span style="">	</span>// attach the "correct" user headers to the request ahead of time.</font></div><div><span style="">	</span>if upgrade {</div><div><span style="">		</span>transport.SetAuthProxyHeaders(newReq, user.GetName(), user.GetGroups(), user.GetExtra())</div><div><span style="">	</span>}</div><div><span style="">	</span>handler := proxy.NewUpgradeAwareHandler(location, proxyRoundTripper, true, upgrade, &amp;responder{w: w})</div><div><span style="">	</span>utilflowcontrol.RequestDelegated(req.Context())</div><div><span style="">	</span><b><font color="#00994d">handler.ServeHTTP(w, newReq)</font></b></div><div>}</div></pre></div></div></div></foreignObject><text x="957" y="2429" fill="#000000" font-family="Helvetica" font-size="12px">func (r *proxyHandler) ServeHTTP(w http.ResponseWriter, req *http.Request) {...</text></switch></g><path d="M 0 2163 L 0 2140 L 890 2140 L 890 2163" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 0 2163 L 0 2690 L 890 2690 L 890 2163" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 0 2163 L 890 2163" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="rgb(0, 0, 0)" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="444.5" y="2156">ServeHTTP (staging/src/k8s.io/apiserver/pkg/server/handler.go)</text></g><rect x="0" y="2160" width="890" height="530" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 888px; height: 1px; padding-top: 2425px; margin-left: 2px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><font color="#7f00ff">// goRestfulContainer: handle restful requests<br />// nonGoRestfulMux: handle non restful requests</font><br /><b>func (d director) ServeHTTP(w http.ResponseWriter, req *http.Request)</b> {<br />	path := req.URL.Path<br /><br />	<font color="#7f00ff">// check to see if our webservices want to claim this path</font><br />	<b><font color="#00994d">for _, ws := range d.goRestfulContainer.RegisteredWebServices()</font></b> {<br />		switch {<br />		case ws.RootPath() == "/apis":<br /><font color="#7f00ff">			// if we are exactly /apis or /apis/, then we need special handling in loop.<br />			// normally these are passed to the nonGoRestfulMux, but if discovery is enabled, it will go directly.<br />			// We can't rely on a prefix match since /apis matches everything (see the big comment on Director above)</font><br />			if path == "/apis" || path == "/apis/" {<br />				klog.V(5).Infof("%v: %v %q satisfied by gorestful with webservice %v", d.name, req.Method, path, ws.RootPath())<br /><font color="#7f00ff">				// don't use servemux here because gorestful servemuxes get messed up when removing webservices<br />				// TODO fix gorestful, remove TPRs, or stop using gorestful</font><br />				<b><font color="#00994d">d.goRestfulContainer.Dispatch(w, req)</font></b><br />				return<br />			}<br /><br />		case strings.HasPrefix(path, ws.RootPath()):<br />			<font color="#7f00ff">// ensure an exact match or a path boundary match</font><br />			if len(path) == len(ws.RootPath()) || path[len(ws.RootPath())] == '/' {<br />				klog.V(5).Infof("%v: %v %q satisfied by gorestful with webservice %v", d.name, req.Method, path, ws.RootPath())<br /><font color="#7f00ff">				// don't use servemux here because gorestful servemuxes get messed up when removing webservices<br />				// TODO fix gorestful, remove TPRs, or stop using gorestful</font><br />				<b><font color="#00994d">d.goRestfulContainer.Dispatch(w, req)</font></b><br />				return<br />			}<br />		}<br />	}<br /><br /><font color="#7f00ff">	// if we didn't find a match, then we just skip gorestful altogether</font><br />	klog.V(5).Infof("%v: %v %q satisfied by nonGoRestful", d.name, req.Method, path)<br />	<b><font color="#00994d">d.nonGoRestfulMux.ServeHTTP(w, req)</font></b><br />}<br /></pre></div></div></div></foreignObject><text x="2" y="2429" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px">// goRestfulContainer: handle restful requests...</text></switch></g><path d="M 2030 1588 L 2030 1565 L 3260 1565 L 3260 1588" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 2030 1588 L 2030 3285 L 3260 3285 L 3260 1588" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 2030 1588 L 3260 1588" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><g fill="#000000" font-family="Helvetica" font-weight="bold" pointer-events="none" text-anchor="middle" font-size="12px"><text x="2644.5" y="1581">ServeHTTP (staging/src/k8s.io/apiextensions-apiserver/pkg/apiserver/customresource_handler.go)</text></g><rect x="2030" y="1585" width="1230" height="1700" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="none"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 1228px; height: 1px; padding-top: 2435px; margin-left: 2032px;"><div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: left;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: none; white-space: normal; overflow-wrap: normal;"><pre><b>func (r *crdHandler) ServeHTTP(w http.ResponseWriter, req *http.Request)</b> {<div><span style="">	</span>ctx := req.Context()</div><div><span style="">	</span><b><font color="#00994d">requestInfo, ok := apirequest.RequestInfoFrom(ctx)</font></b></div><div><span style="">	</span>if !ok {</div><div><span style="">		</span>responsewriters.ErrorNegotiated(</div><div><span style="">			</span>apierrors.NewInternalError(fmt.Errorf("no RequestInfo found in the context")),</div><div><span style="">			</span>Codecs, schema.GroupVersion{}, w, req,</div><div><span style="">		</span>)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><span style="white-space: pre;">	</span><font color="#7f00ff">// not crd request, pass it to other handler</font><br /></div><div><span style="">	</span>if !requestInfo.IsResourceRequest {</div><div><span style="">		</span>pathParts := splitPath(requestInfo.Path)</div><div><span style="">		</span>// only match /apis/&lt;group&gt;/&lt;version&gt;</div><div><span style="">		</span>// only registered under /apis</div><div><span style="">		</span>if len(pathParts) == 3 {</div><div><span style="">			</span>r.versionDiscoveryHandler.ServeHTTP(w, req)</div><div><span style="">			</span>return</div><div><span style="">		</span>}</div><div><span style="">		</span>// only match /apis/&lt;group&gt;</div><div><span style="">		</span>if len(pathParts) == 2 {</div><div><span style="">			</span>r.groupDiscoveryHandler.ServeHTTP(w, req)</div><div><span style="">			</span>return</div><div><span style="">		</span>}</div><div><br /></div><div><span style="">		</span>r.delegate.ServeHTTP(w, req)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>crdName := requestInfo.Resource + "." + requestInfo.APIGroup</div><div><span style="">	</span>crd, err := r.crdLister.Get(crdName)</div><div><span style="white-space: pre;">	</span>...<br /></div><div><br /></div><div><span style="">	</span>// if the scope in the CRD and the scope in request differ (with exception of the verbs in possiblyAcrossAllNamespacesVerbs</div><div><span style="">	</span>// for namespaced resources), pass request to the delegate, which is supposed to lead to a 404.</div><div><span style="">	</span>namespacedCRD, namespacedReq := crd.Spec.Scope == apiextensionsv1.NamespaceScoped, len(requestInfo.Namespace) &gt; 0</div><div><span style="">	</span>if !namespacedCRD &amp;&amp; namespacedReq {</div><div><span style="">		</span>r.delegate.ServeHTTP(w, req)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><span style="">	</span>if namespacedCRD &amp;&amp; !namespacedReq &amp;&amp; !possiblyAcrossAllNamespacesVerbs.Has(requestInfo.Verb) {</div><div><span style="">		</span>r.delegate.ServeHTTP(w, req)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>if !apiextensionshelpers.HasServedCRDVersion(crd, requestInfo.APIVersion) {</div><div><span style="">		</span>r.delegate.ServeHTTP(w, req)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>// There is a small chance that a CRD is being served because NamesAccepted condition is true,</div><div><span style="">	</span>// but it becomes "unserved" because another names update leads to a conflict</div><div><span style="">	</span>// and EstablishingController wasn't fast enough to put the CRD into the Established condition.</div><div><span style="">	</span>// We accept this as the problem is small and self-healing.</div><div><span style="">	</span>if !apiextensionshelpers.IsCRDConditionTrue(crd, apiextensionsv1.NamesAccepted) &amp;&amp;</div><div><span style="">		</span>!apiextensionshelpers.IsCRDConditionTrue(crd, apiextensionsv1.Established) {</div><div><span style="">		</span>r.delegate.ServeHTTP(w, req)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>terminating := apiextensionshelpers.IsCRDConditionTrue(crd, apiextensionsv1.Terminating)</div><div><br /></div><div><span style="">	</span><b><font color="#00994d">crdInfo, err := r.getOrCreateServingInfoFor(crd.UID, crd.Name)</font></b></div><div><span style="white-space: pre;">	</span>...<br /></div><div><span style="">	</span>if !hasServedCRDVersion(crdInfo.spec, requestInfo.APIVersion) {</div><div><span style="">		</span>r.delegate.ServeHTTP(w, req)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>deprecated := crdInfo.deprecated[requestInfo.APIVersion]</div><div><span style="">	</span>for _, w := range crdInfo.warnings[requestInfo.APIVersion] {</div><div><span style="">		</span>warning.AddWarning(req.Context(), "", w)</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>verb := strings.ToUpper(requestInfo.Verb)</div><div><span style="">	</span>resource := requestInfo.Resource</div><div><span style="">	</span>subresource := requestInfo.Subresource</div><div><span style="">	</span>scope := metrics.CleanScope(requestInfo)</div><div><span style="">	</span>supportedTypes := []string{</div><div><span style="">		</span>string(types.JSONPatchType),</div><div><span style="">		</span>string(types.MergePatchType),</div><div><span style="">	</span>}</div><div><span style="">	</span>if utilfeature.DefaultFeatureGate.Enabled(features.ServerSideApply) {</div><div><span style="">		</span>supportedTypes = append(supportedTypes, string(types.ApplyPatchType))</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>var handlerFunc http.HandlerFunc</div><div><span style="">	</span>subresources, err := apiextensionshelpers.GetSubresourcesForVersion(crd, requestInfo.APIVersion)</div><div><span style="">	</span>if err != nil {</div><div><span style="">		</span>utilruntime.HandleError(err)</div><div><span style="">		</span>responsewriters.ErrorNegotiated(</div><div><span style="">			</span>apierrors.NewInternalError(fmt.Errorf("could not properly serve the subresource")),</div><div><span style="">			</span>Codecs, schema.GroupVersion{Group: requestInfo.APIGroup, Version: requestInfo.APIVersion}, w, req,</div><div><span style="">		</span>)</div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div><span style="">	</span>switch {</div><div><span style="">	</span>case subresource == "status" &amp;&amp; subresources != nil &amp;&amp; subresources.Status != nil:</div><div><span style="">		</span>handlerFunc = r.serveStatus(w, req, requestInfo, crdInfo, terminating, supportedTypes)</div><div><span style="">	</span>case subresource == "scale" &amp;&amp; subresources != nil &amp;&amp; subresources.Scale != nil:</div><div><span style="">		</span>handlerFunc = r.serveScale(w, req, requestInfo, crdInfo, terminating, supportedTypes)</div><div><span style="">	</span>case len(subresource) == 0:</div><div><span style="">		</span>handlerFunc = r.serveResource(w, req, requestInfo, crdInfo, crd, terminating, supportedTypes)</div><div><span style="">	</span>default:</div><div><span style="">		</span>responsewriters.ErrorNegotiated(</div><div><span style="">			</span>apierrors.NewNotFound(schema.GroupResource{Group: requestInfo.APIGroup, Resource: requestInfo.Resource}, requestInfo.Name),</div><div><span style="">			</span>Codecs, schema.GroupVersion{Group: requestInfo.APIGroup, Version: requestInfo.APIVersion}, w, req,</div><div><span style="">		</span>)</div><div><span style="">	</span>}</div><div><br /></div><div><span style="">	</span>if handlerFunc != nil {</div><div><span style="">		</span>handlerFunc = metrics.InstrumentHandlerFunc(verb, requestInfo.APIGroup, requestInfo.APIVersion, resource, subresource, scope, metrics.APIServerComponent, deprecated, "", handlerFunc)</div><div><span style="">		</span>handler := genericfilters.WithWaitGroup(handlerFunc, longRunningFilter, crdInfo.waitGroup)</div><div><span style="">		</span><b><font color="#00994d">handler.ServeHTTP(w, req)</font></b></div><div><span style="">		</span>return</div><div><span style="">	</span>}</div><div>}</div></pre></div></div></div></foreignObject><text x="2032" y="2439" fill="#000000" font-family="Helvetica" font-size="12px">func (r *crdHandler) ServeHTTP(w http.ResponseWriter, req *http.Request) {...</text></switch></g><path d="M 1805 2425 L 2023.63 2425" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 2028.88 2425 L 2021.88 2428.5 L 2023.63 2425 L 2021.88 2421.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1380 240 L 1380 273.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1380 278.88 L 1376.5 271.88 L 1380 273.63 L 1383.5 271.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1380 753 L 1380 783.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1380 788.88 L 1376.5 781.88 L 1380 783.63 L 1383.5 781.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1380 1240 L 1380 1273.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1380 1278.88 L 1376.5 1271.88 L 1380 1273.63 L 1383.5 1271.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1379.5 1920 L 1379.5 1940 L 1379.84 1953.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 1379.97 1958.88 L 1376.3 1951.97 L 1379.84 1953.63 L 1383.3 1951.8 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 955 2425 L 896.37 2425" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/><path d="M 891.12 2425 L 898.12 2421.5 L 896.37 2425 L 898.12 2428.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="none"/></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.diagrams.net/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg>